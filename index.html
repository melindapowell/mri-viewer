<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRI Archive</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0c1017;
    --bg-secondary: #151b24;
    --bg-tertiary: #1d2530;
    --bg-hover: #252e3a;
    --text-primary: #e4e7eb;
    --text-secondary: #8b929a;
    --text-dim: #555d67;
    --accent: #5b9bd5;
    --accent-hover: #7cb3e8;
    --border: #252e3a;
    --success: #6db88a;
    --warning: #d4a853;
    --utsw-blue: #004c97;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', sans-serif;
    font-optical-sizing: auto;
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Top Bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 56px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-right: 24px;
    border-right: 1px solid var(--border);
  }

  .logo img {
    height: 26px;
    width: auto;
    filter: brightness(0) invert(1) opacity(0.85);
  }

  .patient-info {
    display: flex;
    gap: 20px;
    font-size: 13px;
  }

  .patient-info .label {
    color: var(--text-dim);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 1px;
  }

  .patient-info .value {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 13px;
    letter-spacing: -0.01em;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .study-date-badge {
    background: rgba(107,184,138,0.08);
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    color: var(--success);
    letter-spacing: -0.01em;
  }

  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    letter-spacing: -0.01em;
  }

  .btn:hover { background: var(--bg-hover); border-color: var(--accent); }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    font-weight: 600;
  }

  .btn-primary:hover { background: var(--accent-hover); }

  /* Main Layout */
  .main {
    display: grid;
    grid-template-columns: 256px 1fr 336px;
    height: calc(100vh - 56px);
  }

  /* Left Sidebar */
  .sidebar {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 14px 0;
  }

  .sidebar::-webkit-scrollbar { width: 5px; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }

  .sidebar-header {
    padding: 6px 18px 14px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    font-weight: 600;
  }

  .study-group { margin-bottom: 2px; }

  .study-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 18px;
    cursor: pointer;
    transition: background 0.1s;
    user-select: none;
  }

  .study-header:hover { background: var(--bg-hover); }

  .study-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .study-icon {
    width: 26px;
    height: 26px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .study-icon.ct { background: rgba(212,168,83,0.12); color: var(--warning); }
  .study-icon.mr { background: rgba(91,155,213,0.12); color: var(--accent); }
  .study-icon.cr { background: rgba(109,184,138,0.12); color: var(--success); }

  .study-name {
    font-size: 13.5px;
    font-weight: 500;
    letter-spacing: -0.01em;
  }

  .study-count {
    font-size: 11px;
    color: var(--text-dim);
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
  }

  .study-chevron {
    font-size: 10px;
    color: var(--text-dim);
    transition: transform 0.2s;
  }

  .study-group.expanded .study-chevron { transform: rotate(90deg); }

  .series-list { display: none; }
  .study-group.expanded .series-list { display: block; }

  .series-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 18px 6px 54px;
    cursor: pointer;
    font-size: 12.5px;
    color: var(--text-secondary);
    transition: all 0.1s;
    border-left: 2px solid transparent;
    letter-spacing: -0.005em;
  }

  .series-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  .series-item.active {
    background: rgba(91,155,213,0.06);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 500;
  }

  .series-count {
    font-size: 11px;
    color: var(--text-dim);
    font-variant-numeric: tabular-nums;
  }

  /* Center Viewer */
  .viewer {
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
  }

  .viewer-header {
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
  }

  .viewer-title {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .viewer-subtitle {
    font-size: 11.5px;
    color: var(--text-secondary);
    margin-top: 1px;
    letter-spacing: -0.005em;
  }

  .slice-indicator {
    font-size: 13px;
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
  }

  .slice-indicator strong { color: var(--text-primary); }

  .image-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    background: #000;
  }

  .image-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    image-rendering: auto;
    transition: filter 0.1s;
  }

  .image-overlay-tl, .image-overlay-tr {
    position: absolute;
    top: 12px;
    font-size: 11px;
    font-weight: 500;
    color: rgba(255,255,255,0.55);
    text-shadow: 0 1px 4px rgba(0,0,0,0.9);
    pointer-events: none;
    letter-spacing: -0.005em;
  }

  .image-overlay-tl { left: 14px; }
  .image-overlay-tr { right: 14px; text-align: right; }

  .viewer-controls {
    padding: 10px 20px 12px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
  }

  .slice-slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .slice-slider-row label {
    font-size: 11px;
    color: var(--text-secondary);
    min-width: 60px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input[type="range"] {
    -webkit-appearance: none;
    flex: 1;
    height: 3px;
    background: var(--bg-hover);
    border-radius: 2px;
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--bg-primary);
  }

  .adjust-row { display: flex; gap: 24px; }

  .adjust-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .adjust-group label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    min-width: 70px;
    font-weight: 500;
  }

  .adjust-group .value {
    font-size: 11px;
    color: var(--text-secondary);
    min-width: 36px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* Right Panel */
  .info-panel {
    background: var(--bg-secondary);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
  }

  .info-panel::-webkit-scrollbar { width: 5px; }
  .info-panel::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }

  .panel-tabs {
    display: flex;
    gap: 1px;
    margin-bottom: 18px;
    background: var(--bg-tertiary);
    border-radius: 7px;
    padding: 3px;
  }

  .panel-tab {
    flex: 1;
    padding: 7px 12px;
    text-align: center;
    font-size: 12.5px;
    cursor: pointer;
    border-radius: 5px;
    color: var(--text-secondary);
    transition: all 0.15s;
    border: none;
    background: none;
    font-family: inherit;
    font-weight: 500;
    letter-spacing: -0.005em;
  }

  .panel-tab:hover { color: var(--text-primary); }
  .panel-tab.active { background: var(--bg-hover); color: var(--text-primary); }

  .panel-section { margin-bottom: 22px; }

  .panel-section-title {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  .info-table {
    width: 100%;
    border-collapse: collapse;
  }

  .info-table td {
    padding: 6px 0;
    font-size: 12.5px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
    letter-spacing: -0.005em;
  }

  .info-table td:first-child {
    color: var(--text-secondary);
    width: 100px;
    padding-right: 12px;
    font-weight: 450;
  }

  .info-table td:last-child { color: var(--text-primary); }

  .report-text {
    font-size: 12.5px;
    line-height: 1.65;
    color: var(--text-primary);
    white-space: pre-wrap;
    font-family: inherit;
    background: var(--bg-tertiary);
    padding: 14px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    max-height: 500px;
    overflow-y: auto;
    letter-spacing: -0.005em;
  }

  .series-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .series-table th {
    text-align: left;
    padding: 6px 8px;
    color: var(--text-dim);
    font-weight: 500;
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .series-table td {
    padding: 5px 8px;
    border-bottom: 1px solid rgba(37,46,58,0.5);
    color: var(--text-secondary);
    letter-spacing: -0.005em;
  }

  .series-table tr:hover td { color: var(--text-primary); }
  .series-table .num { text-align: right; font-variant-numeric: tabular-nums; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 13px;
    gap: 8px;
    letter-spacing: -0.01em;
  }

  .empty-state-icon { font-size: 48px; opacity: 0.25; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    z-index: 100;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    max-width: 480px;
    width: 90%;
  }

  .modal h2 {
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 12px;
    letter-spacing: -0.02em;
  }

  .modal p {
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.55;
    letter-spacing: -0.005em;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo" id="logo-container">
      <img src="/utsw-logo.svg" alt="Institution Logo" onerror="this.parentElement.innerHTML='<span style=&quot;font-size:16px;font-weight:700;color:var(--text-primary)&quot;>MRI Archive</span>'">
    </div>
    <div class="patient-info">
      <div><div class="label">Patient</div><div class="value" id="patientName">Loading...</div></div>
      <div><div class="label">MRN</div><div class="value" id="patientMRN">--</div></div>
    </div>
  </div>
  <div class="topbar-right">
    <button class="btn btn-primary" onclick="exportForInsurance()">Export for Insurance</button>
    <div class="study-date-badge" id="studyDate">--</div>
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">Studies & Series</div>
    <div id="studyList"></div>
  </div>

  <div class="viewer">
    <div class="viewer-header">
      <div>
        <div class="viewer-title" id="viewerTitle">Select a series</div>
        <div class="viewer-subtitle" id="viewerSubtitle"></div>
      </div>
      <div class="slice-indicator" id="sliceIndicator"></div>
    </div>
    <div class="image-container" id="imageContainer">
      <div class="empty-state">
        <div class="empty-state-icon">&#9676;</div>
        Select a series from the left to begin viewing
      </div>
      <img id="viewerImage" style="display:none" alt="DICOM slice">
      <div class="image-overlay-tl" id="overlayTL"></div>
      <div class="image-overlay-tr" id="overlayTR"></div>
    </div>
    <div class="viewer-controls">
      <div class="slice-slider-row">
        <label>Slice</label>
        <input type="range" id="sliceSlider" min="1" max="1" value="1">
      </div>
      <div class="adjust-row">
        <div class="adjust-group">
          <label>Brightness</label>
          <input type="range" id="brightnessSlider" min="0" max="200" value="100">
          <span class="value" id="brightnessVal">100%</span>
        </div>
        <div class="adjust-group">
          <label>Contrast</label>
          <input type="range" id="contrastSlider" min="0" max="200" value="100">
          <span class="value" id="contrastVal">100%</span>
        </div>
      </div>
    </div>
  </div>

  <div class="info-panel">
    <div class="panel-tabs">
      <button class="panel-tab active" data-tab="info">Info</button>
      <button class="panel-tab" data-tab="report">Report</button>
      <button class="panel-tab" data-tab="series">Series</button>
    </div>

    <div id="tab-info" class="tab-content active">
      <div class="panel-section">
        <div class="panel-section-title">Study Information</div>
        <table class="info-table">
          <tr><td>Study Date</td><td id="infoDate">--</td></tr>
          <tr><td>Modality</td><td id="infoModality">--</td></tr>
          <tr><td>Description</td><td id="infoDesc">--</td></tr>
          <tr><td>Institution</td><td id="infoInst">--</td></tr>
          <tr><td>Referring</td><td id="infoRef">--</td></tr>
          <tr><td>Accession</td><td id="infoAccession">--</td></tr>
        </table>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Patient</div>
        <table class="info-table">
          <tr><td>Name</td><td id="infoPatientName">--</td></tr>
          <tr><td>DOB</td><td id="infoPatientDOB">--</td></tr>
          <tr><td>Sex</td><td id="infoPatientSex">--</td></tr>
          <tr><td>ID</td><td id="infoPatientID">--</td></tr>
        </table>
      </div>
    </div>

    <div id="tab-report" class="tab-content">
      <div class="panel-section">
        <div class="panel-section-title" id="reportTitle">Radiology Report</div>
        <div class="report-text" id="reportText">Select a study to view its report.</div>
      </div>
    </div>

    <div id="tab-series" class="tab-content">
      <div class="panel-section">
        <div class="panel-section-title">All Series</div>
        <table class="series-table" id="seriesTable">
          <thead><tr><th>Modality</th><th>Description</th><th class="num">Slices</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="exportModal">
  <div class="modal">
    <h2>Export for Insurance</h2>
    <p>
      This will generate a print-ready summary with patient demographics, study details, representative images, and the full radiology reports. Save as PDF from your browser's print dialog.
    </p>
    <div class="modal-actions">
      <button class="btn" onclick="closeExportModal()">Cancel</button>
      <button class="btn btn-primary" onclick="generateExport()">Generate & Print</button>
    </div>
  </div>
</div>

<script>
function formatDicomName(name) {
  if (!name) return '--';
  const parts = name.split('^').map(s => s.trim()).filter(Boolean);
  if (parts.length === 0) return name;
  const tc = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
  if (parts.length === 1) return tc(parts[0]);
  return `${tc(parts[0])}, ${parts.slice(1).map(tc).join(' ')}`;
}

let data = null;
let currentStudy = null;
let currentSeries = null;
let currentSlice = 0;
let imageCache = {};

// Fetch institution logo SVG for inline embedding in export (optional)
let utswLogoSVG = '';
fetch('/utsw-logo.svg').then(r => { if (!r.ok) throw new Error(); return r.text(); }).then(svg => { utswLogoSVG = svg; }).catch(() => { utswLogoSVG = '<span style="font-size:18px;font-weight:700;color:#004c97">Medical Imaging</span>'; });

async function init() {
  const resp = await fetch('/api/metadata');
  data = await resp.json();

  const p = data.patient;
  const displayName = formatDicomName(p.name);
  document.getElementById('patientName').textContent = displayName;
  document.getElementById('patientMRN').textContent = p.id || '--';
  document.getElementById('infoPatientName').textContent = displayName;
  document.getElementById('infoPatientDOB').textContent = formatDate(p.birthDate);
  document.getElementById('infoPatientSex').textContent = p.sex;
  document.getElementById('infoPatientID').textContent = p.id;

  if (data.studies.length > 0) {
    document.getElementById('studyDate').textContent = formatDate(data.studies[0].date);
  }

  renderStudyList();
  setupControls();

  if (data.studies.length > 0 && data.studies[0].series.length > 0) {
    selectStudy(0);
    selectSeries(0, 0);
  }
}

function formatDate(d) {
  if (!d || d.length < 8) return d || '--';
  return `${d.substring(4,6)}/${d.substring(6,8)}/${d.substring(0,4)}`;
}

function formatDateLong(d) {
  if (!d || d.length < 8) return d || '--';
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  return `${months[parseInt(d.substring(4,6))-1]} ${parseInt(d.substring(6,8))}, ${d.substring(0,4)}`;
}

function renderStudyList() {
  const container = document.getElementById('studyList');
  container.innerHTML = '';

  data.studies.forEach((study, si) => {
    const mod = study.modality.toLowerCase();
    const totalSlices = study.series.reduce((sum, s) => sum + s.sliceCount, 0);
    const group = document.createElement('div');
    group.className = 'study-group';
    group.innerHTML = `
      <div class="study-header" onclick="toggleStudy(this)">
        <div class="study-header-left">
          <div class="study-icon ${mod}">${study.modality}</div>
          <span class="study-name">${study.modality === 'MR' ? 'Brain MRI' : study.modality === 'CT' ? 'Brain CT' : study.description}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="study-count">${totalSlices}</span>
          <span class="study-chevron">&#9654;</span>
        </div>
      </div>
      <div class="series-list">
        ${study.series.map((series, sei) => `
          <div class="series-item" data-study="${si}" data-series="${sei}" onclick="selectSeries(${si}, ${sei})">
            <span>${series.description || 'Series ' + series.number}</span>
            <span class="series-count">${series.sliceCount}</span>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(group);
  });
}

function toggleStudy(header) {
  header.parentElement.classList.toggle('expanded');
}

function selectStudy(studyIndex) {
  currentStudy = data.studies[studyIndex];
  document.getElementById('infoDate').textContent = formatDateLong(currentStudy.date);
  document.getElementById('infoModality').textContent = currentStudy.modality;
  document.getElementById('infoDesc').textContent = currentStudy.description;
  document.getElementById('infoInst').textContent = currentStudy.institution;
  document.getElementById('infoRef').textContent = formatDicomName(currentStudy.referringPhysician);
  document.getElementById('infoAccession').textContent = currentStudy.accession;

  const reportKey = currentStudy.modality;
  const report = data.reports[reportKey] || 'No report available for this study.';
  document.getElementById('reportTitle').textContent = `${currentStudy.modality} Report`;
  document.getElementById('reportText').textContent = report;

  const tbody = document.querySelector('#seriesTable tbody');
  tbody.innerHTML = '';
  data.studies.forEach(study => {
    study.series.forEach(series => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${study.modality}</td><td>${series.description}</td><td class="num">${series.sliceCount}</td>`;
      tbody.appendChild(tr);
    });
  });

  const groups = document.querySelectorAll('.study-group');
  groups[studyIndex]?.classList.add('expanded');
}

function selectSeries(studyIndex, seriesIndex) {
  selectStudy(studyIndex);
  currentSeries = data.studies[studyIndex].series[seriesIndex];
  currentSlice = 0;

  document.querySelectorAll('.series-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.series-item[data-study="${studyIndex}"][data-series="${seriesIndex}"]`)?.classList.add('active');

  document.getElementById('viewerTitle').textContent = currentSeries.description || 'Series ' + currentSeries.number;
  document.getElementById('viewerSubtitle').textContent =
    `${currentStudy.modality} \u2022 ${currentSeries.sliceCount} images`;

  const slider = document.getElementById('sliceSlider');
  slider.max = currentSeries.sliceCount;
  slider.value = Math.floor(currentSeries.sliceCount / 2) + 1;
  currentSlice = parseInt(slider.value) - 1;

  showSlice(currentSlice);
  preloadSlices(currentSlice);
}

function showSlice(index) {
  currentSlice = index;
  const img = document.getElementById('viewerImage');
  const emptyState = document.querySelector('.empty-state');
  const src = '/images/' + currentSeries.images[index];

  img.src = imageCache[src] ? imageCache[src].src : src;
  img.style.display = 'block';
  if (emptyState) emptyState.style.display = 'none';

  document.getElementById('sliceIndicator').innerHTML =
    `<strong>${index + 1}</strong> / ${currentSeries.sliceCount}`;
  document.getElementById('overlayTL').textContent =
    `${currentStudy.modality === 'MR' ? 'Brain MRI' : currentStudy.description}`;
  document.getElementById('overlayTR').innerHTML =
    `${index + 1}/${currentSeries.sliceCount}<br>${currentSeries.description}`;
  applyFilters();
}

function preloadSlices(centerIndex) {
  if (!currentSeries) return;
  for (let i = Math.max(0, centerIndex - 5); i < Math.min(currentSeries.sliceCount, centerIndex + 5); i++) {
    const src = '/images/' + currentSeries.images[i];
    if (!imageCache[src]) {
      const preImg = new Image();
      preImg.src = src;
      imageCache[src] = preImg;
    }
  }
}

function applyFilters() {
  const b = document.getElementById('brightnessSlider').value;
  const c = document.getElementById('contrastSlider').value;
  document.getElementById('viewerImage').style.filter = `brightness(${b}%) contrast(${c}%)`;
}

function setupControls() {
  document.getElementById('sliceSlider').addEventListener('input', e => {
    const idx = parseInt(e.target.value) - 1;
    showSlice(idx);
    preloadSlices(idx);
  });

  document.getElementById('brightnessSlider').addEventListener('input', e => {
    document.getElementById('brightnessVal').textContent = e.target.value + '%';
    applyFilters();
  });

  document.getElementById('contrastSlider').addEventListener('input', e => {
    document.getElementById('contrastVal').textContent = e.target.value + '%';
    applyFilters();
  });

  document.querySelectorAll('.panel-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  document.addEventListener('keydown', e => {
    if (!currentSeries) return;
    const slider = document.getElementById('sliceSlider');
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault();
      slider.value = Math.max(1, parseInt(slider.value) - 1);
      showSlice(parseInt(slider.value) - 1);
      preloadSlices(parseInt(slider.value) - 1);
    } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault();
      slider.value = Math.min(parseInt(slider.max), parseInt(slider.value) + 1);
      showSlice(parseInt(slider.value) - 1);
      preloadSlices(parseInt(slider.value) - 1);
    }
  });

  document.getElementById('imageContainer').addEventListener('wheel', e => {
    if (!currentSeries) return;
    e.preventDefault();
    const slider = document.getElementById('sliceSlider');
    const delta = e.deltaY > 0 ? 1 : -1;
    const newVal = Math.max(1, Math.min(parseInt(slider.max), parseInt(slider.value) + delta));
    slider.value = newVal;
    showSlice(newVal - 1);
    preloadSlices(newVal - 1);
  });
}

function exportForInsurance() {
  document.getElementById('exportModal').classList.add('active');
}

function closeExportModal() {
  document.getElementById('exportModal').classList.remove('active');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function normalizeReportText(text) {
  let lines = text.split('\n');
  let paragraphs = [];
  let current = '';
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed === '') {
      if (current.trim()) paragraphs.push(current.trim());
      current = '';
    } else {
      current = current ? current + ' ' + trimmed : trimmed;
    }
  }
  if (current.trim()) paragraphs.push(current.trim());
  return paragraphs.join('\n\n');
}

function formatImpressionAsNumbered(text) {
  const normalized = normalizeReportText(text);
  const combined = normalized.replace(/\n\n/g, ' ');
  const re = /(\d+)\.\s+/g;
  const positions = [];
  let match;
  while ((match = re.exec(combined)) !== null) {
    positions.push({ idx: match.index, num: match[1], contentStart: match.index + match[0].length });
  }
  if (positions.length === 0) return `<div class="rs-body">${escapeHtml(normalized)}</div>`;
  let html = '<div class="impression-list">';
  for (let i = 0; i < positions.length; i++) {
    const start = positions[i].contentStart;
    const end = i + 1 < positions.length ? positions[i + 1].idx : combined.length;
    const itemText = combined.substring(start, end).trim();
    html += `<div class="impression-item">
      <span class="imp-num">${positions[i].num}.</span>
      <span class="imp-text">${escapeHtml(itemText)}</span>
    </div>`;
  }
  html += '</div>';
  return html;
}

function formatReportBody(rawText) {
  let cleaned = rawText.replace(/\r\n/g, '\n');
  const lines = cleaned.split('\n');
  const sections = [];
  let currentSection = null;
  const sectionHeaders = ['EXAM:', 'CLINICAL HISTORY:', 'HISTORY:', 'CLINICAL INDICATION:', 'TECHNIQUE:', 'COMPARISON:', 'FINDINGS:', 'IMPRESSION:', 'RECOMMENDATIONS:', 'RECOMMENDATION:', 'ADDENDUM:'];

  for (const line of lines) {
    const trimmed = line.trim();
    const upper = trimmed.toUpperCase();
    const matchedHeader = sectionHeaders.find(h => upper.startsWith(h));
    if (matchedHeader) {
      currentSection = { header: matchedHeader.replace(/:$/, ''), lines: [] };
      sections.push(currentSection);
      const remainder = trimmed.substring(matchedHeader.length).trim();
      if (remainder) currentSection.lines.push(remainder);
    } else if (currentSection) {
      currentSection.lines.push(trimmed);
    }
  }

  let signingPhysician = '';
  const signPatterns = [
    /Electronically\s+signed\s+by[:\s]+([A-Z][a-z]+(?:\s+[A-Z]\.?)?\s+[A-Z][a-z]+(?:,?\s*(?:M\.?D\.?|D\.?O\.?))?)/i,
    /Signed\s+by[:\s]+([A-Z][a-z]+(?:\s+[A-Z]\.?)?\s+[A-Z][a-z]+(?:,?\s*(?:M\.?D\.?|D\.?O\.?))?)/i,
    /([A-Z][a-z]+(?:\s+[A-Z]\.?)?\s+[A-Z][a-z]+),?\s+M\.?D\.?,?\s+(?:electronically|digitally)/i,
  ];
  for (const pat of signPatterns) {
    const m = rawText.match(pat);
    if (m) { signingPhysician = m[1].trim(); break; }
  }
  if (!signingPhysician) {
    const lastLines = lines.slice(-8);
    for (const l of lastLines) {
      const m = l.match(/([A-Z][a-z]+(?:\s+[A-Z]\.?)?\s+[A-Z][a-z]+),?\s+M\.?D\.?/);
      if (m) { signingPhysician = m[0].trim(); break; }
    }
  }

  let html = '';
  if (signingPhysician) {
    html += `<div class="report-physician">
      <span class="rp-label">Interpreting Physician</span>
      <span class="rp-name">${escapeHtml(signingPhysician)}</span>
    </div>`;
  }

  const shortSections = new Set(['EXAM', 'CLINICAL HISTORY', 'HISTORY', 'CLINICAL INDICATION', 'TECHNIQUE', 'COMPARISON']);
  const order = ['EXAM', 'CLINICAL HISTORY', 'HISTORY', 'CLINICAL INDICATION', 'TECHNIQUE', 'COMPARISON', 'FINDINGS', 'IMPRESSION', 'RECOMMENDATIONS', 'RECOMMENDATION', 'ADDENDUM'];
  const rendered = new Set();

  let shortPairs = [];
  for (const name of order) {
    if (!shortSections.has(name)) continue;
    const sec = sections.find(s => s.header === name && !rendered.has(s));
    if (!sec) continue;
    rendered.add(sec);
    let body = normalizeReportText(sec.lines.join('\n'));
    if (!body) continue;
    shortPairs.push({ label: name, value: body });
  }

  if (shortPairs.length > 0) {
    html += `<div class="report-grid">`;
    shortPairs.forEach(pair => {
      html += `<div class="rg-label">${escapeHtml(pair.label)}</div>`;
      html += `<div class="rg-value">${escapeHtml(pair.value)}</div>`;
    });
    html += `</div>`;
  }

  for (const name of order) {
    if (shortSections.has(name)) continue;
    const sec = sections.find(s => s.header === name && !rendered.has(s));
    if (!sec) continue;
    rendered.add(sec);
    let body = sec.lines.join('\n');
    if (!normalizeReportText(body)) continue;
    const isImpression = name === 'IMPRESSION';
    html += `<div class="report-section${isImpression ? ' impression' : ''}">`;
    html += `<div class="rs-header">${escapeHtml(name)}</div>`;
    if (isImpression) {
      html += formatImpressionAsNumbered(body);
    } else {
      html += `<div class="rs-body">${escapeHtml(normalizeReportText(body))}</div>`;
    }
    html += `</div>`;
  }
  return html;
}

// Per-study image pairs — verified against actual DVD source files
const STUDY_IMAGES = {
  CT: [
    { seriesMatch: 'NCCT HEAD',  slice: 87, label: 'NCCT HEAD' },
    { seriesMatch: 'SAG',        slice: 9,  label: 'SAG iDose' },
  ],
  MR: [
    { seriesMatch: 'AAHead_Scout',    slice: 74, label: 'AAHead Scout' },
    { seriesMatch: 'AX T2 FLAIR FS', slice: 15, label: 'AX T2 FLAIR FS' },
  ],
};

  const GALLERY_IMAGES = [
    { modality: 'CT', seriesMatch: 'NCCT SRC',           slice: 17, label: 'NCCT SRC' },
    { modality: 'CT', seriesMatch: 'BONE 5MM',           slice: 16, label: 'BONE 5MM' },
    { modality: 'CT', seriesMatch: 'COR',                slice: 23, label: 'COR iDose' },
    { modality: 'MR', seriesMatch: 'SAG T1 FLAIR',       slice: 13, label: 'SAG T1 FLAIR' },
    { modality: 'MR', seriesMatch: 'AX DWI',             slice: 14, label: 'AX DWI/ADC' },
    { modality: 'MR', seriesMatch: 'AX T1 SE',           slice: 14, label: 'AX T1 SE' },
    { modality: 'MR', seriesMatch: 'SWI_Images',         slice: 29, label: 'SWI' },
    { modality: 'MR', seriesMatch: 'AX T1 FLAIR FS POST',slice: 14, label: 'AX T1 FLAIR POST' },
    { modality: 'MR', seriesMatch: 'AX T2 BLADE POST',  slice: 14, label: 'AX T2 BLADE POST' },
  ];

function findSeriesImage(study, match, sliceIdx) {
  const series = study.series.find(s => s.description && s.description.toUpperCase().includes(match.toUpperCase()));
  if (!series) return null;
  const idx = Math.min(sliceIdx, series.sliceCount - 1);
  return { src: '/images/' + series.images[idx], sliceNum: idx + 1, total: series.sliceCount, desc: series.description };
}

function generateExport() {
  closeExportModal();
  const win = window.open('', '_blank');
  const p = data.patient;
  const displayName = formatDicomName(p.name);
  const studyDate = data.studies.length > 0 ? formatDateLong(data.studies[0].date) : '--';

  let html = `<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<title>Medical Imaging Report \u2014 ${displayName}</title>
<meta name="generator" content="DICOM Viewer Export v9">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  @page {
    size: letter;
    margin: 0.6in 0.75in;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', sans-serif;
    font-optical-sizing: auto;
    color: #1a1a1a;
    line-height: 1.55;
    -webkit-font-smoothing: antialiased;
    max-width: 8.5in;
    margin: 0 auto;
    padding: 40px 64px;
    font-size: 12px;
  }

  /* Header */
  .doc-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 20px;
    border-bottom: 2.5px solid #004c97;
    margin-bottom: 24px;
  }
  .doc-header-left { display: flex; align-items: center; gap: 16px; }
  .doc-header-left svg { height: 36px; width: auto; }
  .doc-header-right { text-align: right; }
  .doc-header-right .doc-title {
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: #004c97;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 2px;
  }
  .doc-header-right .doc-subtitle {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: #555;
    font-weight: 500;
  }

  /* Patient banner */
  .patient-banner {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 0.7fr;
    gap: 0;
    background: #f5f7fa;
    border: 1px solid #dfe3ea;
    border-radius: 4px;
    padding: 20px 28px;
    margin-bottom: 28px;
    align-items: center;
    page-break-inside: avoid;
  }
  .patient-banner .pb-name {
    border-right: 1px solid #cdd3dc;
    padding-right: 28px;
    margin-right: 0;
  }
  .patient-banner .pb-field {
    padding-left: 28px;
  }
  .patient-banner .field-label {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #999;
    margin-bottom: 4px;
  }
  .patient-banner .field-value {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: #1a1a1a;
  }
  .patient-banner .field-value.patient-name {
    font-size: 20px;
    font-weight: 700;
    color: #111;
    white-space: nowrap;
  }

  /* Study sections */
  .study-section {
    margin-bottom: 36px;
  }
  .study-section.page-break {
    page-break-before: always;
  }
  .study-section-header {
    display: flex;
    align-items: baseline;
    gap: 14px;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 2px solid #004c97;
    page-break-inside: avoid;
  }
  .study-section-title {
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: #1a1a1a;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    line-height: 1.3;
  }
  .study-section-badge {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #004c97;
    background: rgba(0,76,151,0.08);
    padding: 4px 12px;
    border-radius: 3px;
  }

  /* Study details grid */
  .study-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px 32px;
    margin-bottom: 16px;
  }
  .study-detail {
    display: flex;
    gap: 8px;
    font-size: 12px;
    padding: 3px 0;
  }
  .study-detail .dl {
    color: #888;
    font-weight: 500;
    min-width: 100px;
    flex-shrink: 0;
  }
  .study-detail .dv {
    color: #1a1a1a;
    font-weight: 450;
  }
  .study-detail .dv.date-val {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
  }

  /* Image pair — two images spanning full width, same height */
  .image-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-bottom: 20px;
    page-break-inside: avoid;
  }
  .image-pair-cell {
    overflow: hidden;
    border-radius: 3px;
    border: 1px solid #ccc;
    background: #000;
    display: flex;
    flex-direction: column;
  }
  .image-pair-cell .img-wrap {
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    aspect-ratio: 4/3;
  }
  .image-pair-cell .img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  .image-pair-cell .caption {
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    color: #666;
    font-weight: 500;
    padding: 6px 8px;
    background: #fff;
    border-top: 1px solid #e5e5e5;
    letter-spacing: -0.005em;
  }


  /* Image gallery back page */
  .gallery-page {
    page-break-before: always;
  }
  .gallery-page-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #1a1a1a;
    margin-bottom: 6px;
  }
  .gallery-page-subtitle {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: #888;
    margin-bottom: 20px;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .gallery-cell {
    overflow: hidden;
    border-radius: 3px;
    border: 1px solid #ccc;
    background: #000;
    display: flex;
    flex-direction: column;
  }
  .gallery-cell .g-img {
    aspect-ratio: 1/1;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }
  .gallery-cell .g-img img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  .gallery-cell .g-caption {
    font-family: 'DM Sans', sans-serif;
    font-size: 9px;
    color: #666;
    font-weight: 500;
    padding: 5px 7px;
    background: #fff;
    border-top: 1px solid #e5e5e5;
    letter-spacing: -0.005em;
  }
  .gallery-cell .g-caption .g-mod {
    font-weight: 700;
    color: #004c97;
    margin-right: 4px;
  }
  /* Report */
  .report-heading {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #555;
    margin-bottom: 12px;
    page-break-after: avoid;
  }
  .report-container {
    background: #fafbfc;
    border: 1px solid #e2e5ea;
    border-radius: 5px;
    padding: 24px 30px;
  }
  .report-physician {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e2e5ea;
    page-break-inside: avoid;
  }
  .report-physician .rp-label {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #999;
  }
  .report-physician .rp-name {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  /* Report two-column grid */
  .report-grid {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 8px 20px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #eceef1;
    align-items: baseline;
    page-break-inside: avoid;
  }
  .report-grid .rg-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #004c97;
    padding-top: 2px;
  }
  .report-grid .rg-value {
    font-size: 11.5px;
    line-height: 1.6;
    color: #333;
  }

  /* Report long sections */
  .report-section {
    margin-bottom: 16px;
  }
  .report-section:last-child { margin-bottom: 0; }
  .report-section .rs-header {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #004c97;
    margin-bottom: 6px;
    page-break-after: avoid;
  }
  .report-section .rs-body {
    font-size: 11.5px;
    line-height: 1.7;
    color: #333;
    letter-spacing: -0.005em;
  }

  /* Impression */
  .report-section.impression {
    background: rgba(0,76,151,0.04);
    border-left: 3px solid #004c97;
    padding: 16px 22px;
    border-radius: 0 4px 4px 0;
    margin-top: 18px;
    page-break-inside: avoid;
  }
  .report-section.impression .rs-header {
    font-size: 12px;
    letter-spacing: 0.08em;
    color: #003a75;
  }
  .impression-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .impression-item {
    display: flex;
    gap: 8px;
    font-size: 11.5px;
    line-height: 1.7;
    color: #1a1a1a;
    font-weight: 450;
    letter-spacing: -0.005em;
  }
  .impression-item .imp-num {
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    color: #004c97;
    flex-shrink: 0;
    min-width: 18px;
  }
  .impression-item .imp-text {
    flex: 1;
  }

  /* Divider */
  .section-divider {
    border: none;
    border-top: 1px solid #e2e5ea;
    margin: 32px 0;
  }

  /* Footer */
  .doc-footer {
    margin-top: 40px;
    padding-top: 14px;
    border-top: 1px solid #d8dce2;
    font-size: 10px;
    color: #999;
    letter-spacing: -0.005em;
    text-align: center;
  }

  /* Print */
  .no-print { margin: 24px 0; text-align: center; }
  .no-print button {
    font-family: 'Inter', sans-serif;
    padding: 10px 28px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    background: #004c97;
    color: #fff;
    border: none;
    border-radius: 6px;
  }
  .no-print button:hover { background: #003d7a; }
  @media print {
    body { padding: 0; }
    .no-print { display: none !important; }
  }
</style>
</head><body>`;

  // Header
  html += `<div class="doc-header">
    <div class="doc-header-left">${utswLogoSVG}</div>
    <div class="doc-header-right">
      <div class="doc-title">Medical Imaging Report</div>
      <div class="doc-subtitle">${studyDate}</div>
    </div>
  </div>`;

  // Patient banner
  html += `<div class="patient-banner">
    <div class="pb-name"><div class="field-label">Patient Name</div><div class="field-value patient-name">${displayName}</div></div>
    <div class="pb-field"><div class="field-label">Date of Birth</div><div class="field-value">${formatDate(p.birthDate)}</div></div>
    <div class="pb-field"><div class="field-label">Patient ID</div><div class="field-value">${p.id}</div></div>
    <div class="pb-field"><div class="field-label">Sex</div><div class="field-value">${p.sex === 'F' ? 'Female' : p.sex === 'M' ? 'Male' : p.sex}</div></div>
  </div>`;

  // Studies — each with images between header and report
  const mainStudies = data.studies.filter(s => s.modality === 'CT' || s.modality === 'MR');
  const studiesToShow = mainStudies.length > 0 ? mainStudies : data.studies;

  studiesToShow.forEach((study, idx) => {
    html += `<div class="study-section${idx > 0 ? ' page-break' : ''}">
      <div class="study-section-header">
        <div class="study-section-title">${study.description}</div>
        <div class="study-section-badge">${study.modality}</div>
      </div>
      <div class="study-details">
        <div class="study-detail"><span class="dl">Study Date</span><span class="dv date-val">${formatDateLong(study.date)}</span></div>
        <div class="study-detail"><span class="dl">Accession</span><span class="dv">${study.accession}</span></div>
        <div class="study-detail"><span class="dl">Institution</span><span class="dv">${study.institution}</span></div>
        <div class="study-detail"><span class="dl">Referring</span><span class="dv">${formatDicomName(study.referringPhysician)}</span></div>
      </div>`;

    // Image pair for this study
    const imageDefs = STUDY_IMAGES[study.modality] || [];
    const images = imageDefs.map(sel => {
      const found = findSeriesImage(study, sel.seriesMatch, sel.slice);
      if (found) return { ...found, label: sel.label };
      return null;
    }).filter(Boolean);

    if (images.length === 2) {
      html += `<div class="image-pair">`;
      images.forEach(img => {
        html += `<div class="image-pair-cell">
          <div class="img-wrap"><img src="${img.src}" alt="${img.desc}"></div>
          <div class="caption">${img.label} \u00b7 ${img.sliceNum}/${img.total}</div>
        </div>`;
      });
      html += `</div>`;
    }

    // Report
    const reportKey = study.modality;
    if (data.reports[reportKey]) {
      html += `<div class="report-heading">Radiology Report</div>`;
      html += `<div class="report-container">${formatReportBody(data.reports[reportKey])}</div>`;
    }

    html += `</div>`;
  });


  // Gallery back page — additional images
  html += `<div class="gallery-page">
    <div class="gallery-page-title">Additional Imaging</div>
    <div class="gallery-page-subtitle">Selected slices from CT and MR studies \u00b7 ${studyDate}</div>
    <div class="gallery-grid">`;

  GALLERY_IMAGES.forEach(gi => {
    const study = data.studies.find(s => s.modality === gi.modality);
    if (!study) return;
    const found = findSeriesImage(study, gi.seriesMatch, gi.slice);
    if (!found) return;
    html += `<div class="gallery-cell">
      <div class="g-img"><img src="${found.src}" alt="${found.desc}"></div>
      <div class="g-caption"><span class="g-mod">${gi.modality}</span>${gi.label} · ${found.sliceNum}/${found.total}</div>
    </div>`;
  });

  html += `</div></div>`;

  // Footer
  html += `<div class="doc-footer">
    <span>${studiesToShow.length > 0 && studiesToShow[0].institution ? studiesToShow[0].institution : "Medical Imaging Report"}</span>
  </div>`;

  html += `<div class="no-print"><button onclick="window.print()">Save as PDF</button></div>`;
  html += `</body></html>`;

  win.document.write(html);
  win.document.close();
}

init();
</script>
</body>
</html>